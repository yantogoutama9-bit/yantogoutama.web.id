<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master ERP + HR Management + Payroll</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-tab { background: white; padding: 12px 24px; border-radius: 25px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.3s; border: none; font-weight: 600; }
        .nav-tab:hover, .nav-tab.active { background: #667eea; color: white; transform: translateY(-2px); }
        .section { background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); display: none; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stat-card.warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.info { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-value { font-size: 2.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        button { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        button.success { background: #27ae60; }
        button.success:hover { background: #229954; }
        button.secondary { background: #95a5a6; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge.active { background: #d4edda; color: #155724; }
        .badge.inactive { background: #f8d7da; color: #721c24; }
        .badge.sales { background: #fff3cd; color: #856404; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #999; }
        .close:hover { color: #333; }
        .gender-chart { display: flex; height: 30px; border-radius: 15px; overflow: hidden; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .gender-male { background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; transition: width 0.5s; }
        .gender-female { background: #f093fb; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; transition: width 0.5s; }
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar input, .filter-bar select { width: auto; min-width: 200px; }
        .turnover-rate { font-size: 1.2em; font-weight: bold; color: #e74c3c; }
        .payroll-slip { background: white; border: 2px solid #333; padding: 40px; max-width: 800px; margin: 0 auto; font-family: 'Courier New', monospace; }
        .payroll-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .payroll-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .payroll-company { font-size: 14px; margin-bottom: 5px; }
        .payroll-address { font-size: 12px; color: #666; font-style: italic; }
        .payroll-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
        .payroll-section h3 { border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px; font-size: 16px; }
        .payroll-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .payroll-row.total { font-weight: bold; border-top: 1px solid #333; padding-top: 10px; margin-top: 10px; }
        .payroll-info { display: grid; grid-template-columns: 120px 1fr; gap: 10px; margin-bottom: 30px; font-size: 14px; }
        .payroll-info-label { font-weight: bold; }
        .payroll-signature { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 50px; }
        .signature-box { text-align: center; }
        .signature-line { border-top: 1px solid #333; margin-top: 60px; padding-top: 5px; font-size: 12px; }
        .input-manual { background: #fff3cd; border: 1px solid #ffc107; }
        .input-auto { background: #d4edda; border: 1px solid #28a745; }
        .search-box { position: relative; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background: #f8f9fa; }
        .hidden { display: none; }
        @media print { .no-print { display: none; } body { background: white; } .payroll-slip { border: none; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¢ Master ERP + HR Management + Payroll</h1>
            <p>Sistem Enterprise Resource Planning dengan Modul Human Resource dan Payroll Terintegrasi</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('hr')">üë• HR / Karyawan</button>
            <button class="nav-tab" onclick="showSection('payroll')">üíµ Slip Gaji</button>
            <button class="nav-tab" onclick="showSection('master')">üß© Master Data</button>
            <button class="nav-tab" onclick="showSection('purchasing')">üõí Purchasing</button>
            <button class="nav-tab" onclick="showSection('inventory')">üì¶ Inventory</button>
            <button class="nav-tab" onclick="showSection('production')">üè≠ Production</button>
            <button class="nav-tab" onclick="showSection('sales')">üíº Sales</button>
            <button class="nav-tab" onclick="showSection('finance')">üí∞ Finance</button>
        </div>

        <!-- HR Section -->
        <div id="hr" class="section">
            <h2>üë• Manajemen Karyawan</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalEmployees">0</div>
                    <div class="stat-label">Total Karyawan</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="activeEmployees">0</div>
                    <div class="stat-label">Karyawan Aktif</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="inactiveEmployees">0</div>
                    <div class="stat-label">Karyawan Non-Aktif</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="totalSales">0</div>
                    <div class="stat-label">Tim Sales</div>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <h3>üë´ Komposisi Gender</h3>
                <div class="gender-chart">
                    <div class="gender-male" id="maleBar" style="width: 0%">0%</div>
                    <div class="gender-female" id="femaleBar" style="width: 0%">0%</div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <span>üë® Pria: <strong id="maleCount">0</strong></span>
                    <span>üë© Wanita: <strong id="femaleCount">0</strong></span>
                </div>
            </div>

            <div style="background: #fee; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                <h3>üìâ Turnover Rate</h3>
                <div class="turnover-rate" id="turnoverRate">0%</div>
                <small>Perhitungan: (Karyawan Keluar / Total Karyawan) √ó 100</small>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <h3>üéØ Kontribusi Tim Sales</h3>
                <p>Total Sales Order oleh Tim Sales: <strong id="salesContribution">Rp 0</strong></p>
                <p>Persentase dari Total Penjualan: <strong id="salesPercentage">0%</strong></p>
            </div>

            <div style="margin: 20px 0;">
                <button onclick="openEmployeeModal()">‚ûï Tambah Karyawan</button>
            </div>

            <div class="filter-bar">
                <input type="text" id="searchEmployee" placeholder="üîç Cari nama/NIP..." onkeyup="filterEmployees()">
                <select id="filterStatus" onchange="filterEmployees()">
                    <option value="">Semua Status</option>
                    <option value="active">Aktif</option>
                    <option value="inactive">Non-Aktif</option>
                </select>
                <select id="filterUnit" onchange="filterEmployees()">
                    <option value="">Semua Unit</option>
                    <option value="sales">Sales</option>
                    <option value="production">Production</option>
                    <option value="finance">Finance</option>
                    <option value="warehouse">Warehouse</option>
                    <option value="hr">HR</option>
                </select>
            </div>

            <table id="employeeTable">
                <thead>
                    <tr>
                        <th>NIP</th>
                        <th>Nama</th>
                        <th>Jenis Kelamin</th>
                        <th>Jabatan</th>
                        <th>Unit</th>
                        <th>Tgl Masuk</th>
                        <th>Gaji</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody"></tbody>
            </table>
        </div>

        <!-- Payroll / Slip Gaji Section -->
        <div id="payroll" class="section">
            <h2>üíµ Slip Gaji Karyawan</h2>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h3>üîç Cari Karyawan</h3>
                <div class="search-box">
                    <input type="text" id="searchPayrollEmployee" placeholder="Ketik nama atau NIP karyawan..." 
                           onkeyup="searchEmployeeForPayroll()" autocomplete="off">
                    <div id="payrollSearchResults" class="search-results"></div>
                </div>
                <small style="color: #666;">* Data gaji pokok akan terisi otomatis saat memilih karyawan</small>
            </div>

            <div id="payrollForm" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Periode (Bulan/Tahun)</label>
                        <input type="text" id="payrollPeriod" placeholder="Februari 2026" class="input-manual">
                    </div>
                    <div class="form-group">
                        <label>Alamat Unit</label>
                        <input type="text" id="payrollAddress" placeholder="Jl. Kenari F-12..." class="input-manual">
                    </div>
                </div>

                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>üìã Data Karyawan (Auto-fill)</h4>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 14px;">
                        <div><strong>Nama:</strong> <span id="payrollName">-</span></div>
                        <div><strong>NIP:</strong> <span id="payrollNIP">-</span></div>
                        <div><strong>Unit:</strong> <span id="payrollUnit">-</span></div>
                        <div><strong>Jabatan:</strong> <span id="payrollPosition">-</span></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <strong>Gaji Pokok:</strong> <span id="payrollBasicSalary">Rp 0</span>
                    </div>
                </div>

                <h3>üí∞ Komponen Gaji (Input Manual)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <!-- Penerimaan -->
                    <div style="background: #d4edda; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #155724; margin-bottom: 15px;">‚ûï PENERIMAAN</h4>
                        <div class="form-group">
                            <label>Gaji Pokok (Auto)</label>
                            <input type="text" id="pokok" readonly class="input-auto">
                        </div>
                        <div class="form-group">
                            <label>Tunjangan Jabatan</label>
                            <input type="number" id="tunjanganJabatan" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Perjalanan Dinas</label>
                            <input type="number" id="perjalananDinas" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Lembur</label>
                            <input type="number" id="lembur" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group" style="border-top: 2px solid #28a745; padding-top: 10px; margin-top: 15px;">
                            <label style="color: #155724; font-weight: bold;">Gaji Kotor</label>
                            <input type="text" id="gajiKotor" readonly style="font-weight: bold; color: #155724;">
                        </div>
                    </div>

                    <!-- Potongan -->
                    <div style="background: #f8d7da; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #721c24; margin-bottom: 15px;">‚ûñ POTONGAN</h4>
                        <div class="form-group">
                            <label>Tidak Masuk Kerja</label>
                            <input type="number" id="potonganAbsen" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Terlambat</label>
                            <input type="number" id="potonganTerlambat" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Pulang Cepat / Izin 1/2 Hari</label>
                            <input type="number" id="potonganPulangCepat" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Potongan Bon</label>
                            <input type="number" id="potonganBon" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Potongan Seragam</label>
                            <input type="number" id="potonganSeragam" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group">
                            <label>Potongan BPJS</label>
                            <input type="number" id="potonganBPJS" value="0" class="input-manual" onchange="calculatePayroll()">
                        </div>
                        <div class="form-group" style="border-top: 2px solid #dc3545; padding-top: 10px; margin-top: 15px;">
                            <label style="color: #721c24; font-weight: bold;">Total Potongan</label>
                            <input type="text" id="totalPotongan" readonly style="font-weight: bold; color: #721c24;">
                        </div>
                    </div>
                </div>

                <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; border: 2px solid #17a2b8;">
                    <h3 style="color: #0c5460; margin-bottom: 10px;">TOTAL GAJI YANG DITERIMA</h3>
                    <div style="font-size: 32px; font-weight: bold; color: #0c5460;" id="totalGaji">Rp 0</div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="generateSlipPreview()">üëÅÔ∏è Preview Slip</button>
                    <button onclick="exportPayrollToExcel()" class="success">üìä Export Excel</button>
                    <button onclick="printSlip()" class="secondary">üñ®Ô∏è Print</button>
                    <button onclick="resetPayroll()" class="danger">üîÑ Reset</button>
                </div>
            </div>

            <!-- Preview Slip Gaji -->
            <div id="slipPreview" style="display: none; margin-top: 30px;">
                <div class="payroll-slip" id="slipContent">
                    <div class="payroll-header">
                        <div class="payroll-title">SLIP GAJI BULANAN</div>
                        <div class="payroll-company" id="slipUnit">UNIT : <span id="slipUnitText"></span></div>
                        <div class="payroll-address" id="slipAddress"></div>
                    </div>

                    <div class="payroll-info">
                        <div class="payroll-info-label">Periode</div>
                        <div id="slipPeriod"></div>
                        
                        <div class="payroll-info-label">Nama</div>
                        <div id="slipName"></div>
                        
                        <div class="payroll-info-label">Jabatan</div>
                        <div id="slipPosition"></div>
                        
                        <div class="payroll-info-label">NIP</div>
                        <div id="slipNIP"></div>
                    </div>

                    <div class="payroll-grid">
                        <div class="payroll-section">
                            <h3>PENERIMAAN</h3>
                            <div class="payroll-row">
                                <span>Gaji Pokok</span>
                                <span id="slipPokok"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Tunjangan Jabatan</span>
                                <span id="slipTunjanganJabatan"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Perjalanan Dinas</span>
                                <span id="slipPerjalananDinas"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Lembur</span>
                                <span id="slipLembur"></span>
                            </div>
                            <div class="payroll-row total">
                                <span>Gaji Kotor</span>
                                <span id="slipGajiKotor"></span>
                            </div>
                        </div>

                        <div class="payroll-section">
                            <h3>POTONGAN</h3>
                            <div class="payroll-row">
                                <span>Tidak Masuk Kerja</span>
                                <span id="slipPotonganAbsen"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Terlambat</span>
                                <span id="slipPotonganTerlambat"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Pulang Cepat / Izin 1/2 Hari</span>
                                <span id="slipPotonganPulangCepat"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Potongan Bon</span>
                                <span id="slipPotonganBon"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Potongan Seragam</span>
                                <span id="slipPotonganSeragam"></span>
                            </div>
                            <div class="payroll-row">
                                <span>Potongan BPJS</span>
                                <span id="slipPotonganBPJS"></span>
                            </div>
                            <div class="payroll-row total">
                                <span>Total Potongan</span>
                                <span id="slipTotalPotongan"></span>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px; padding: 20px; border: 2px solid #333; font-weight: bold; font-size: 18px;">
                        TOTAL GAJI YANG DITERIMA: <span id="slipTotalGaji"></span>
                    </div>

                    <div class="payroll-signature">
                        <div class="signature-box">
                            <div class="signature-line">Dibuat Oleh<br>HRD</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">Diterima Oleh<br>Karyawan</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Sections -->
        <div id="dashboard" class="section">
            <h2>üìä Dashboard Utama</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="dashStock">Rp 0</div>
                    <div class="stat-label">Nilai Stok</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="dashSales">Rp 0</div>
                    <div class="stat-label">Sales Bulan Ini</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="dashProfit">Rp 0</div>
                    <div class="stat-label">Profit Bulan Ini</div>
                </div>
            </div>
        </div>

        <div id="master" class="section">
            <h2>üß© Master Data</h2>
            <p>Vendor ‚Ä¢ Customer ‚Ä¢ Items</p>
        </div>
        <div id="purchasing" class="section">
            <h2>üõí Purchasing</h2>
            <p>Purchase Order & Penerimaan Barang</p>
        </div>
        <div id="inventory" class="section">
            <h2>üì¶ Inventory</h2>
            <p>Manajemen Stok & Penyesuaian</p>
        </div>
        <div id="production" class="section">
            <h2>üè≠ Production</h2>
            <p>Work Order & Produksi</p>
        </div>
        <div id="sales" class="section">
            <h2>üíº Sales</h2>
            <p>Sales Order & Invoice</p>
        </div>
        <div id="finance" class="section">
            <h2>üí∞ Finance</h2>
            <p>Cashflow & Laporan Keuangan</p>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmployeeModal()">&times;</span>
            <h2 id="modalTitle">Tambah Karyawan Baru</h2>
            <form id="employeeForm" onsubmit="saveEmployee(event)">
                <input type="hidden" id="editIndex">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label>Nomor Induk Pegawai (NIP) *</label>
                        <input type="text" id="nip" required placeholder="contoh: EMP001">
                    </div>
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" id="nama" required placeholder="Nama lengkap karyawan">
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin *</label>
                        <select id="gender" required>
                            <option value="">Pilih</option>
                            <option value="Laki-laki">üë® Laki-laki</option>
                            <option value="Perempuan">üë© Perempuan</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Lahir *</label>
                        <input type="date" id="tglLahir" required>
                    </div>
                    <div class="form-group">
                        <label>Nomor WhatsApp *</label>
                        <input type="tel" id="noWA" required placeholder="08xxxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>Alamat Email *</label>
                        <input type="email" id="email" required placeholder="email@company.com">
                    </div>
                    <div class="form-group">
                        <label>Tanggal Masuk *</label>
                        <input type="date" id="tglMasuk" required>
                    </div>
                    <div class="form-group">
                        <label>Unit/Bagian *</label>
                        <select id="unit" required onchange="checkSalesUnit()">
                            <option value="">Pilih Unit</option>
                            <option value="sales">üéØ Sales/Marketing</option>
                            <option value="production">üè≠ Production</option>
                            <option value="finance">üí∞ Finance</option>
                            <option value="warehouse">üì¶ Warehouse</option>
                            <option value="hr">üë• HR</option>
                            <option value="it">üíª IT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jabatan *</label>
                        <input type="text" id="jabatan" required placeholder="contoh: Sales Executive">
                    </div>
                    <div class="form-group">
                        <label>Gaji Pokok (Rp) *</label>
                        <input type="number" id="gaji" required placeholder="5000000">
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="isActive" checked onchange="toggleTanggalKeluar()"> Karyawan Aktif
                    </label>
                </div>

                <div class="form-group" id="tanggalKeluarGroup" style="display: none;">
                    <label>Tanggal Keluar</label>
                    <input type="date" id="tglKeluar">
                </div>

                <div style="margin-top: 30px;">
                    <button type="submit">üíæ Simpan Karyawan</button>
                    <button type="button" onclick="closeEmployeeModal()" style="background: #95a5a6; margin-left: 10px;">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let employees = JSON.parse(localStorage.getItem('erp_employees')) || [];
        let salesData = JSON.parse(localStorage.getItem('erp_sales')) || [];
        let currentPayrollEmployee = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderEmployees();
            updateHRStats();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if(sectionId === 'hr') updateHRStats();
        }

        // Employee Functions
        function openEmployeeModal(index = null) {
            document.getElementById('employeeModal').style.display = 'flex';
            document.getElementById('employeeForm').reset();
            document.getElementById('editIndex').value = '';
            document.getElementById('modalTitle').textContent = 'Tambah Karyawan Baru';
            document.getElementById('tanggalKeluarGroup').style.display = 'none';
            
            if(index !== null) {
                const emp = employees[index];
                document.getElementById('editIndex').value = index;
                document.getElementById('nip').value = emp.nip;
                document.getElementById('nama').value = emp.nama;
                document.getElementById('gender').value = emp.gender;
                document.getElementById('tglLahir').value = emp.tglLahir;
                document.getElementById('noWA').value = emp.noWA;
                document.getElementById('email').value = emp.email;
                document.getElementById('tglMasuk').value = emp.tglMasuk;
                document.getElementById('unit').value = emp.unit;
                document.getElementById('jabatan').value = emp.jabatan;
                document.getElementById('gaji').value = emp.gaji;
                document.getElementById('isActive').checked = emp.isActive;
                document.getElementById('tglKeluar').value = emp.tglKeluar || '';
                toggleTanggalKeluar();
                document.getElementById('modalTitle').textContent = 'Edit Data Karyawan';
            }
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
        }

        function toggleTanggalKeluar() {
            const isActive = document.getElementById('isActive').checked;
            document.getElementById('tanggalKeluarGroup').style.display = isActive ? 'none' : 'block';
        }

        function checkSalesUnit() {
            const unit = document.getElementById('unit').value;
            const jabatan = document.getElementById('jabatan');
            if(unit === 'sales' && !jabatan.value.includes('Sales')) {
                jabatan.value = 'Sales ' + (jabatan.value || 'Executive');
            }
        }

        function saveEmployee(e) {
            e.preventDefault();
            
            const employee = {
                nip: document.getElementById('nip').value,
                nama: document.getElementById('nama').value,
                gender: document.getElementById('gender').value,
                tglLahir: document.getElementById('tglLahir').value,
                noWA: document.getElementById('noWA').value,
                email: document.getElementById('email').value,
                tglMasuk: document.getElementById('tglMasuk').value,
                unit: document.getElementById('unit').value,
                jabatan: document.getElementById('jabatan').value,
                gaji: parseFloat(document.getElementById('gaji').value),
                isActive: document.getElementById('isActive').checked,
                tglKeluar: document.getElementById('tglKeluar').value || null,
                createdAt: new Date().toISOString()
            };

            const editIndex = document.getElementById('editIndex').value;
            
            if(editIndex !== '') {
                employees[editIndex] = { ...employees[editIndex], ...employee };
            } else {
                if(employees.find(emp => emp.nip === employee.nip)) {
                    alert('NIP sudah terdaftar!');
                    return;
                }
                employees.push(employee);
            }

            localStorage.setItem('erp_employees', JSON.stringify(employees));
            renderEmployees();
            updateHRStats();
            closeEmployeeModal();
        }

        function renderEmployees(filtered = employees) {
            const tbody = document.getElementById('employeeTableBody');
            tbody.innerHTML = '';

            filtered.forEach((emp, index) => {
                const row = tbody.insertRow();
                const statusClass = emp.isActive ? 'active' : 'inactive';
                const statusText = emp.isActive ? 'Aktif' : 'Non-Aktif';
                
                row.innerHTML = `
                    <td><strong>${emp.nip}</strong></td>
                    <td>${emp.nama}</td>
                    <td>${emp.gender === 'Laki-laki' ? 'üë®' : 'üë©'} ${emp.gender}</td>
                    <td>${emp.unit === 'sales' ? 'üéØ ' : ''}${emp.jabatan}</td>
                    <td><span class="badge ${emp.unit === 'sales' ? 'sales' : ''}">${emp.unit.toUpperCase()}</span></td>
                    <td>${formatDate(emp.tglMasuk)}</td>
                    <td>Rp ${emp.gaji.toLocaleString()}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="openEmployeeModal(${index})" style="padding: 5px 10px; font-size: 12px;">‚úèÔ∏è Edit</button>
                        <button onclick="deleteEmployee(${index})" class="danger" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">üóëÔ∏è Hapus</button>
                    </td>
                `;
            });
        }

        function deleteEmployee(index) {
            if(confirm('Yakin ingin menghapus karyawan ini?')) {
                employees.splice(index, 1);
                localStorage.setItem('erp_employees', JSON.stringify(employees));
                renderEmployees();
                updateHRStats();
            }
        }

        function filterEmployees() {
            const search = document.getElementById('searchEmployee').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const unit = document.getElementById('filterUnit').value;

            const filtered = employees.filter(emp => {
                const matchSearch = emp.nama.toLowerCase().includes(search) || emp.nip.toLowerCase().includes(search);
                const matchStatus = !status || (status === 'active' ? emp.isActive : !emp.isActive);
                const matchUnit = !unit || emp.unit === unit;
                return matchSearch && matchStatus && matchUnit;
            });

            renderEmployees(filtered);
        }

        function updateHRStats() {
            const total = employees.length;
            const active = employees.filter(e => e.isActive).length;
            const inactive = total - active;
            const male = employees.filter(e => e.gender === 'Laki-laki').length;
            const female = employees.filter(e => e.gender === 'Perempuan').length;
            const salesTeam = employees.filter(e => e.unit === 'sales' && e.isActive).length;

            document.getElementById('totalEmployees').textContent = total;
            document.getElementById('activeEmployees').textContent = active;
            document.getElementById('inactiveEmployees').textContent = inactive;
            document.getElementById('totalSales').textContent = salesTeam;
            document.getElementById('maleCount').textContent = male;
            document.getElementById('femaleCount').textContent = female;

            const malePercent = total > 0 ? (male / total * 100).toFixed(1) : 0;
            const femalePercent = total > 0 ? (female / total * 100).toFixed(1) : 0;
            
            document.getElementById('maleBar').style.width = malePercent + '%';
            document.getElementById('maleBar').textContent = male > 0 ? malePercent + '%' : '';
            document.getElementById('femaleBar').style.width = femalePercent + '%';
            document.getElementById('femaleBar').textContent = female > 0 ? femalePercent + '%' : '';

            const resigned = employees.filter(e => !e.isActive && e.tglKeluar).length;
            const turnoverRate = total > 0 ? ((resigned / total) * 100).toFixed(2) : 0;
            document.getElementById('turnoverRate').textContent = turnoverRate + '%';

            const totalSales = salesData.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const salesBySalesTeam = totalSales * 0.8;
            document.getElementById('salesContribution').textContent = 'Rp ' + salesBySalesTeam.toLocaleString();
            document.getElementById('salesPercentage').textContent = '80%';
        }

        // Payroll Functions
        function searchEmployeeForPayroll() {
            const search = document.getElementById('searchPayrollEmployee').value.toLowerCase();
            const resultsDiv = document.getElementById('payrollSearchResults');
            
            if(search.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            const matches = employees.filter(emp => 
                emp.isActive && (
                    emp.nama.toLowerCase().includes(search) || 
                    emp.nip.toLowerCase().includes(search)
                )
            );

            if(matches.length > 0) {
                resultsDiv.innerHTML = matches.map(emp => `
                    <div class="search-result-item" onclick="selectEmployeeForPayroll('${emp.nip}')">
                        <strong>${emp.nama}</strong> (${emp.nip})<br>
                        <small>${emp.jabatan} - ${emp.unit}</small>
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div class="search-result-item">Tidak ada karyawan ditemukan</div>';
                resultsDiv.style.display = 'block';
            }
        }

        function selectEmployeeForPayroll(nip) {
            const emp = employees.find(e => e.nip === nip);
            if(!emp) return;

            currentPayrollEmployee = emp;
            document.getElementById('payrollSearchResults').style.display = 'none';
            document.getElementById('searchPayrollEmployee').value = emp.nama + ' (' + emp.nip + ')';
            document.getElementById('payrollForm').style.display = 'block';

            // Auto-fill data
            document.getElementById('payrollName').textContent = emp.nama;
            document.getElementById('payrollNIP').textContent = emp.nip;
            document.getElementById('payrollUnit').textContent = emp.unit.toUpperCase();
            document.getElementById('payrollPosition').textContent = emp.jabatan;
            document.getElementById('payrollBasicSalary').textContent = 'Rp ' + emp.gaji.toLocaleString();
            
            document.getElementById('pokok').value = 'Rp ' + emp.gaji.toLocaleString();
            
            // Set unit in slip
            document.getElementById('slipUnitText').textContent = emp.unit.toUpperCase();
            
            calculatePayroll();
        }

        function calculatePayroll() {
            if(!currentPayrollEmployee) return;

            const pokok = currentPayrollEmployee.gaji;
            const tunjanganJabatan = parseFloat(document.getElementById('tunjanganJabatan').value) || 0;
            const perjalananDinas = parseFloat(document.getElementById('perjalananDinas').value) || 0;
            const lembur = parseFloat(document.getElementById('lembur').value) || 0;

            const potonganAbsen = parseFloat(document.getElementById('potonganAbsen').value) || 0;
            const potonganTerlambat = parseFloat(document.getElementById('potonganTerlambat').value) || 0;
            const potonganPulangCepat = parseFloat(document.getElementById('potonganPulangCepat').value) || 0;
            const potonganBon = parseFloat(document.getElementById('potonganBon').value) || 0;
            const potonganSeragam = parseFloat(document.getElementById('potonganSeragam').value) || 0;
            const potonganBPJS = parseFloat(document.getElementById('potonganBPJS').value) || 0;

            const gajiKotor = pokok + tunjanganJabatan + perjalananDinas + lembur;
            const totalPotongan = potonganAbsen + potonganTerlambat + potonganPulangCepat + potonganBon + potonganSeragam + potonganBPJS;
            const totalGaji = gajiKotor - totalPotongan;

            document.getElementById('gajiKotor').value = 'Rp ' + gajiKotor.toLocaleString();
            document.getElementById('totalPotongan').value = 'Rp ' + totalPotongan.toLocaleString();
            document.getElementById('totalGaji').textContent = 'Rp ' + totalGaji.toLocaleString();
        }

        function generateSlipPreview() {
            if(!currentPayrollEmployee) {
                alert('Pilih karyawan terlebih dahulu!');
                return;
            }

            document.getElementById('slipPreview').style.display = 'block';
            
            // Header info
            document.getElementById('slipUnitText').textContent = document.getElementById('payrollUnit').textContent;
            document.getElementById('slipAddress').textContent = document.getElementById('payrollAddress').value;
            document.getElementById('slipPeriod').textContent = document.getElementById('payrollPeriod').value;
            
            // Employee info
            document.getElementById('slipName').textContent = currentPayrollEmployee.nama;
            document.getElementById('slipPosition').textContent = currentPayrollEmployee.jabatan;
            document.getElementById('slipNIP').textContent = currentPayrollEmployee.nip;

            // Penerimaan
            document.getElementById('slipPokok').textContent = document.getElementById('pokok').value;
            document.getElementById('slipTunjanganJabatan').textContent = 'Rp ' + (parseFloat(document.getElementById('tunjanganJabatan').value) || 0).toLocaleString();
            document.getElementById('slipPerjalananDinas').textContent = 'Rp ' + (parseFloat(document.getElementById('perjalananDinas').value) || 0).toLocaleString();
            document.getElementById('slipLembur').textContent = 'Rp ' + (parseFloat(document.getElementById('lembur').value) || 0).toLocaleString();
            document.getElementById('slipGajiKotor').textContent = document.getElementById('gajiKotor').value;

            // Potongan
            document.getElementById('slipPotonganAbsen').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganAbsen').value) || 0).toLocaleString();
            document.getElementById('slipPotonganTerlambat').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganTerlambat').value) || 0).toLocaleString();
            document.getElementById('slipPotonganPulangCepat').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganPulangCepat').value) || 0).toLocaleString();
            document.getElementById('slipPotonganBon').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganBon').value) || 0).toLocaleString();
            document.getElementById('slipPotonganSeragam').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganSeragam').value) || 0).toLocaleString();
            document.getElementById('slipPotonganBPJS').textContent = 'Rp ' + (parseFloat(document.getElementById('potonganBPJS').value) || 0).toLocaleString();
            document.getElementById('slipTotalPotongan').textContent = document.getElementById('totalPotongan').value;

            // Total
            document.getElementById('slipTotalGaji').textContent = document.getElementById('totalGaji').textContent;

            // Scroll to preview
            document.getElementById('slipPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function exportPayrollToExcel() {
            if(!currentPayrollEmployee) {
                alert('Pilih karyawan terlebih dahulu!');
                return;
            }

            const period = document.getElementById('payrollPeriod').value || 'Slip_Gaji';
            const filename = `Slip_Gaji_${currentPayrollEmployee.nama}_${period}`.replace(/\s+/g, '_');

            // Prepare data for Excel
            const data = [
                ['SLIP GAJI BULANAN'],
                [''],
                ['UNIT', document.getElementById('payrollUnit').textContent],
                [document.getElementById('payrollAddress').value],
                [''],
                ['Periode', document.getElementById('payrollPeriod').value],
                ['Nama', currentPayrollEmployee.nama],
                ['Jabatan', currentPayrollEmployee.jabatan],
                ['NIP', currentPayrollEmployee.nip],
                [''],
                ['PENERIMAAN', '', 'POTONGAN', ''],
                ['Gaji Pokok', document.getElementById('pokok').value, 'Tidak Masuk Kerja', 'Rp ' + (parseFloat(document.getElementById('potonganAbsen').value) || 0).toLocaleString()],
                ['Tunjangan Jabatan', 'Rp ' + (parseFloat(document.getElementById('tunjanganJabatan').value) || 0).toLocaleString(), 'Terlambat', 'Rp ' + (parseFloat(document.getElementById('potonganTerlambat').value) || 0).toLocaleString()],
                ['Perjalanan Dinas', 'Rp ' + (parseFloat(document.getElementById('perjalananDinas').value) || 0).toLocaleString(), 'Pulang Cepat / Izin 1/2 Hari', 'Rp ' + (parseFloat(document.getElementById('potonganPulangCepat').value) || 0).toLocaleString()],
                ['Lembur', 'Rp ' + (parseFloat(document.getElementById('lembur').value) || 0).toLocaleString(), 'Potongan Bon', 'Rp ' + (parseFloat(document.getElementById('potonganBon').value) || 0).toLocaleString()],
                ['', '', 'Potongan Seragam', 'Rp ' + (parseFloat(document.getElementById('potonganSeragam').value) || 0).toLocaleString()],
                ['', '', 'Potongan BPJS', 'Rp ' + (parseFloat(document.getElementById('potonganBPJS').value) || 0).toLocaleString()],
                [''],
                ['Gaji Kotor', document.getElementById('gajiKotor').value, 'Total Potongan', document.getElementById('totalPotongan').value],
                [''],
                ['TOTAL GAJI YANG DITERIMA', document.getElementById('totalGaji').textContent],
                [''],
                ['Dibuat Oleh:', '', 'Diterima Oleh:'],
                ['HRD', '', 'Karyawan']
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Slip Gaji");
            XLSX.writeFile(wb, filename + ".xlsx");
        }

        function printSlip() {
            if(document.getElementById('slipPreview').style.display === 'none') {
                generateSlipPreview();
            }
            window.print();
        }

        function resetPayroll() {
            document.getElementById('searchPayrollEmployee').value = '';
            document.getElementById('payrollForm').style.display = 'none';
            document.getElementById('slipPreview').style.display = 'none';
            document.getElementById('payrollPeriod').value = '';
            document.getElementById('payrollAddress').value = '';
            
            // Reset inputs
            ['tunjanganJabatan', 'perjalananDinas', 'lembur', 'potonganAbsen', 'potonganTerlambat', 
             'potonganPulangCepat', 'potonganBon', 'potonganSeragam', 'potonganBPJS'].forEach(id => {
                document.getElementById(id).value = 0;
            });
            
            currentPayrollEmployee = null;
        }

        function formatDate(dateString) {
            if(!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }

        window.onclick = function(event) {
            if(event.target === document.getElementById('employeeModal')) {
                closeEmployeeModal();
            }
        }
    </script>
</body>
</html>
